var background=(function(){"use strict";const r=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome;function P(e){return e==null||typeof e=="function"?{main:e}:e}const c={globalMode:"detection-only",siteSettings:{},customStylesEnabled:!1,customStyles:{},suppressedNotificationDomains:[],onboardingComplete:!1,loggingEnabled:!0},g=new Map,b=new Map;function h(e,t,n,o){let i=b.get(e);if(!i||i.domain!==n){const s=f(n,o);i={domain:n,url:t,timestamp:Date.now(),events:[],protectionMode:s.mode,blocked:s.protectionEnabled},b.set(e,i)}return i}async function d(e,t,n,o,i,s){console.log("[GRAPES] logSurveillanceEvent called:",{tabId:e,domain:n,eventType:o,details:i,blocked:s});const a=await r.storage.sync.get(["preferences"]).then(p=>p.preferences||c),l=h(e,t,n,a);console.log("[GRAPES] Current entry events before:",l.events.length);const u=l.events.find(p=>p.type===o);u?(u.details=[...new Set([...u.details,...i])],u.timestamp=Date.now()):l.events.push({type:o,details:i,timestamp:Date.now(),blocked:s}),console.log("[GRAPES] Entry events after:",l.events.length),console.log("[GRAPES] tabLogEntries has entry:",b.has(e)),a.loggingEnabled?(console.log("[GRAPES] Persisting log entry..."),await T(l),console.log("[GRAPES] Log entry persisted")):console.log("[GRAPES] Logging disabled, not persisting")}async function T(e){console.log("[GRAPES] persistLogEntry called for domain:",e.domain);const n=(await r.storage.local.get(["surveillanceLogs"])).surveillanceLogs||[];console.log("[GRAPES] Existing logs count:",n.length);const o=new Date(e.timestamp).toDateString(),i=n.findIndex(s=>s.domain===e.domain&&new Date(s.timestamp).toDateString()===o);if(i>=0){const s=n[i];for(const a of e.events){const l=s.events.find(u=>u.type===a.type);l?(l.details=[...new Set([...l.details,...a.details])],l.timestamp=Math.max(l.timestamp,a.timestamp)):s.events.push(a)}s.timestamp=Math.max(s.timestamp,e.timestamp)}else n.push(e),n.length>100&&n.shift();await r.storage.local.set({surveillanceLogs:n}),console.log("[GRAPES] Logs saved to storage, new count:",n.length)}const G=P(()=>{console.log("[GRAPES] Background script initialized"),r.runtime.onInstalled.addListener(e=>{e.reason==="install"?(console.log("[GRAPES] Extension installed"),r.storage.sync.set({preferences:c}),r.tabs.create({url:r.runtime.getURL("onboarding.html")})):e.reason==="update"&&r.storage.sync.get(["preferences"]).then(t=>{const n=t.preferences;if(n&&!("globalMode"in n)){const o={...c,customStylesEnabled:n.enabled||!1,customStyles:n.customStyles||{},onboardingComplete:!0};r.storage.sync.set({preferences:o}),console.log("[GRAPES] Migrated preferences to new format")}})}),r.runtime.onMessage.addListener((e,t)=>{if(e.type==="SUSPICIOUS_OBSERVATION_DETECTED"){if(console.log("[GRAPES] Suspicious observation reported:",e.data),t.tab?.id&&t.tab.url){const n=E(new URL(t.tab.url).hostname),o=g.get(t.tab.id)||{mutationObserver:!1,sessionReplay:[],fingerprinting:[],visibilityTracking:!1,trackingPixels:[],timestamp:Date.now()};o.mutationObserver=!0,o.timestamp=Date.now(),g.set(t.tab.id,o),console.log("[GRAPES] Updated tabSurveillance for tab",t.tab.id,":",o),S(t.tab.id,o),r.storage.sync.get(["preferences"]).then(i=>{const s=i.preferences||c,a=f(n,s);d(t.tab.id,t.tab.url,n,"dom-monitoring",[e.data?.targetType||"unknown"],a.protectionEnabled)}).catch(i=>console.error("[GRAPES] Error logging dom-monitoring event:",i))}return}if(e.type==="SESSION_REPLAY_DETECTED"){if(console.log("[GRAPES] Session replay tools detected:",e.data),t.tab?.id&&t.tab.url){const n=E(new URL(t.tab.url).hostname),o=g.get(t.tab.id)||{mutationObserver:!1,sessionReplay:[],fingerprinting:[],visibilityTracking:!1,trackingPixels:[],timestamp:Date.now()};o.sessionReplay=e.data.tools||[],o.timestamp=Date.now(),g.set(t.tab.id,o),console.log("[GRAPES] Updated tabSurveillance for tab",t.tab.id),S(t.tab.id,o),r.storage.sync.get(["preferences"]).then(i=>{const s=i.preferences||c,a=f(n,s);d(t.tab.id,t.tab.url,n,"session-replay",e.data.tools||[],a.protectionEnabled)}).catch(i=>console.error("[GRAPES] Error logging session-replay event:",i))}return}if(e.type==="FINGERPRINTING_DETECTED"){if(console.log("[GRAPES] Fingerprinting detected:",e.data),t.tab?.id&&t.tab.url){const n=E(new URL(t.tab.url).hostname),o=g.get(t.tab.id)||{mutationObserver:!1,sessionReplay:[],fingerprinting:[],visibilityTracking:!1,trackingPixels:[],timestamp:Date.now()},i=e.data.types||[];o.fingerprinting=[...new Set([...o.fingerprinting,...i])],o.timestamp=Date.now(),g.set(t.tab.id,o),console.log("[GRAPES] Updated tabSurveillance for tab",t.tab.id),S(t.tab.id,o),r.storage.sync.get(["preferences"]).then(s=>{const a=s.preferences||c,l=f(n,a);d(t.tab.id,t.tab.url,n,"fingerprinting",i,l.protectionEnabled)}).catch(s=>console.error("[GRAPES] Error logging fingerprinting event:",s))}return}if(e.type==="VISIBILITY_TRACKING_DETECTED"){if(console.log("[GRAPES] Visibility tracking detected:",e.data),t.tab?.id&&t.tab.url){const n=E(new URL(t.tab.url).hostname),o=g.get(t.tab.id)||{mutationObserver:!1,sessionReplay:[],fingerprinting:[],visibilityTracking:!1,trackingPixels:[],timestamp:Date.now()};o.visibilityTracking=!0,o.timestamp=Date.now(),g.set(t.tab.id,o),console.log("[GRAPES] Updated tabSurveillance for tab",t.tab.id),S(t.tab.id,o),r.storage.sync.get(["preferences"]).then(i=>{const s=i.preferences||c,a=f(n,s);d(t.tab.id,t.tab.url,n,"visibility-tracking",["tab-switch"],a.protectionEnabled)}).catch(i=>console.error("[GRAPES] Error logging visibility-tracking event:",i))}return}if(e.type==="TRACKING_PIXEL_DETECTED"){if(console.log("[GRAPES] Tracking pixels detected:",e.data),t.tab?.id&&t.tab.url){const n=E(new URL(t.tab.url).hostname),o=g.get(t.tab.id)||{mutationObserver:!1,sessionReplay:[],fingerprinting:[],visibilityTracking:!1,trackingPixels:[],timestamp:Date.now()},i=e.data.types||[];o.trackingPixels=[...new Set([...o.trackingPixels,...i])],o.timestamp=Date.now(),g.set(t.tab.id,o),console.log("[GRAPES] Updated tabSurveillance for tab",t.tab.id),S(t.tab.id,o),r.storage.sync.get(["preferences"]).then(s=>{const a=s.preferences||c,l=f(n,a);d(t.tab.id,t.tab.url,n,"tracking-pixel",i,l.protectionEnabled)}).catch(s=>console.error("[GRAPES] Error logging tracking-pixel event:",s))}return}if(e.type==="GET_SURVEILLANCE_DATA")return t.tab?.id?Promise.resolve(g.get(t.tab.id)||null):Promise.resolve(null);if(e.type==="GET_TAB_SURVEILLANCE"){const n=e.tabId;console.log("[GRAPES] GET_TAB_SURVEILLANCE request for tabId:",n),console.log("[GRAPES] tabSurveillance keys:",[...g.keys()]);const o=n&&g.get(n)||null;return console.log("[GRAPES] Returning surveillance data:",o),Promise.resolve(o)}if(e.type==="GET_CURRENT_LOG_ENTRY"){const n=e.tabId;console.log("[GRAPES] GET_CURRENT_LOG_ENTRY request for tabId:",n),console.log("[GRAPES] tabLogEntries keys:",[...b.keys()]);const o=n&&b.get(n)||null;return console.log("[GRAPES] Returning log entry:",o),Promise.resolve(o)}if(e.type==="GET_ALL_LOGS")return console.log("[GRAPES] GET_ALL_LOGS request"),r.storage.local.get(["surveillanceLogs"]).then(n=>{const o=n.surveillanceLogs||[];return console.log("[GRAPES] Returning",o.length,"logs"),o});if(e.type==="CLEAR_LOGS")return r.storage.local.remove(["surveillanceLogs"]).then(()=>({success:!0}));if(e.type==="GET_PROTECTION_STATUS")return r.storage.sync.get(["preferences"]).then(n=>{const o=n.preferences||c,i=e.domain;return f(i,o)});if(e.type==="SET_SITE_PROTECTION"){const{domain:n,setting:o}=e;return r.storage.sync.get(["preferences"]).then(i=>{const s=i.preferences||c;return s.siteSettings[n]=o,r.storage.sync.set({preferences:s}).then(()=>(console.log(`[GRAPES] Site protection for ${n} set to ${o}`),{success:!0}))})}if(e.type==="SET_GLOBAL_MODE"){const{mode:n}=e;return r.storage.sync.get(["preferences"]).then(o=>{const i=o.preferences||c;return i.globalMode=n,r.storage.sync.set({preferences:i}).then(()=>(console.log(`[GRAPES] Global mode set to ${n}`),{success:!0}))})}if(e.type==="GET_PREFERENCES")return r.storage.sync.get(["preferences"]).then(n=>n.preferences||c);if(e.type==="SET_PREFERENCES")return r.storage.sync.set({preferences:e.preferences}).then(()=>({success:!0}));if(e.type==="COMPLETE_ONBOARDING")return r.storage.sync.get(["preferences"]).then(n=>{const o=n.preferences||c;return o.onboardingComplete=!0,r.storage.sync.set({preferences:o}).then(()=>({success:!0}))});if(e.type==="ADD_SUPPRESSED_DOMAIN"){const{domain:n}=e;return r.storage.sync.get(["preferences"]).then(o=>{const i=o.preferences||c;return i.suppressedNotificationDomains.includes(n)||i.suppressedNotificationDomains.push(n),r.storage.sync.set({preferences:i}).then(()=>(console.log(`[GRAPES] Added ${n} to notification suppression list`),{success:!0}))})}if(e.type==="REMOVE_SUPPRESSED_DOMAIN"){const{domain:n}=e;return r.storage.sync.get(["preferences"]).then(o=>{const i=o.preferences||c;return i.suppressedNotificationDomains=i.suppressedNotificationDomains.filter(s=>s!==n),r.storage.sync.set({preferences:i}).then(()=>(console.log(`[GRAPES] Removed ${n} from notification suppression list`),{success:!0}))})}if(e.type==="SET_LOGGING_ENABLED"){const{enabled:n}=e;return r.storage.sync.get(["preferences"]).then(o=>{const i=o.preferences||c;return i.loggingEnabled=n,r.storage.sync.set({preferences:i}).then(()=>(console.log(`[GRAPES] Logging ${n?"enabled":"disabled"}`),{success:!0}))})}}),r.tabs.onUpdated.addListener((e,t)=>{t.status==="loading"&&(m(e),g.delete(e))}),r.tabs.onRemoved.addListener(e=>{g.delete(e)})});function S(e,t){const n=t.fingerprinting.length>0,o=t.sessionReplay.length>0,i=t.mutationObserver,s=t.visibilityTracking,a=t.trackingPixels.length>0,l=(n?1:0)+(o?1:0)+(i?1:0)+(s?1:0)+(a?1:0);if(l===0){m(e);return}r.action.setBadgeText({text:l.toString(),tabId:e});let u="#e94560";s&&(u="#3498db"),a&&(u="#e67e22"),o&&(u="#f39c12"),n&&(u="#9b59b6"),r.action.setBadgeBackgroundColor({color:u,tabId:e}),r.action.setBadgeTextColor({color:"#ffffff",tabId:e});const p=[];i&&p.push("DOM monitoring"),s&&p.push("Visibility tracking"),a&&p.push(`Tracking pixels (${t.trackingPixels.join(", ")})`),o&&p.push(`Session replay (${t.sessionReplay.join(", ")})`),n&&p.push(`Fingerprinting (${t.fingerprinting.join(", ")})`),r.action.setTitle({title:`GRAPES: ${p.join(", ")}`,tabId:e}),console.log(`[GRAPES] Badge updated for tab ${e}:`,p)}function m(e){r.action.setBadgeText({text:"",tabId:e}),r.action.setTitle({title:"GRAPES Settings",tabId:e})}function f(e,t){const n=E(e),o=t.siteSettings[n]||null;if(o==="enabled")return{protectionEnabled:!0,mode:"full",siteOverride:o};if(o==="disabled")return{protectionEnabled:!1,mode:"disabled",siteOverride:o};const i=t.globalMode;return{protectionEnabled:i==="full",mode:i,siteOverride:o}}function E(e){if(e==="localhost"||/^\d+\.\d+\.\d+\.\d+$/.test(e))return e;const t=e.split(".");if(t.length<=2)return e;const n=["co.uk","com.br","com.au","co.jp","co.in","com.mx"],o=t.slice(-2).join(".");return n.includes(o)&&t.length>2?t.slice(-3).join("."):t.slice(-2).join(".")}function L(){}function y(e,...t){}const A={debug:(...e)=>y(console.debug,...e),log:(...e)=>y(console.log,...e),warn:(...e)=>y(console.warn,...e),error:(...e)=>y(console.error,...e)};let R;try{R=G.main(),R instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw A.error("The background crashed on startup!"),e}return R})();
